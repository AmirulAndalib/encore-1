#!/system/bin/sh

sync

last_gamepreloaded="/data/encore/last_gamepreloaded"

gameCache=(
	"cache/vulkan_pso_cache.bin"
	"cache/UnityShaderCache"
	"files/ProgramBinaryCache"
)

itemsGameStuff=()

graphicLibs64=(
	"/system/lib64/libGLESv1_CM.so"
	"/system/lib64/libGLESv2.so"
	"/system/lib64/libGLESv3.so"
	"/system/lib64/libvulkan.so"
	"/system/lib64/libskia.so"
	"/system/lib64/libEGL.so"
	"/system/lib64/libgsl.so"
	"/system/lib64/libRS.so"
	"/system/lib64/libsurfaceflinger.so"
	"/vendor/lib64/hw/vulkan.adreno.so"
	"/vendor/lib64/egl/libGLES_mali.so"
	"/vendor/lib64/egl/libEGL_powervr.so"
	"/vendor/lib64/egl/libEGL_adreno.so"
	"/vendor/lib64/egl/libGLESv1_CM_adreno.so"
	"/vendor/lib64/egl/libGLESv2_adreno.so"
	"/vendor/lib64/egl/libGLESv1_CM_powervr.so"
	"/vendor/lib64/egl/libGLESv2_powervr.so"
)

graphicLibs32=(
	"/system/lib/libGLESv1_CM.so"
	"/system/lib/libGLESv2.so"
	"/system/lib/libGLESv3.so"
	"/system/lib/libvulkan.so"
	"/system/lib/libskia.so"
	"/system/lib/libEGL.so"
	"/system/lib/libgsl.so"
	"/system/lib/libRS.so"
	"/system/lib/libsurfaceflinger.so"
	"/vendor/lib/hw/vulkan.adreno.so"
	"/vendor/lib/egl/libGLES_mali.so"
	"/vendor/lib/egl/libEGL_powervr.so"
	"/vendor/lib/egl/libEGL_adreno.so"
	"/vendor/lib/egl/libGLESv1_CM_adreno.so"
	"/vendor/lib/egl/libGLESv2_adreno.so"
	"/vendor/lib/egl/libGLESv1_CM_powervr.so"
	"/vendor/lib/egl/libGLESv2_powervr.so"
)

preloadGraphicLibs() {
	echo 3 >/proc/sys/vm/drop_caches
	su -c vmtouch -Ld ${graphicLibs64[@]} ${graphicLibs32[@]}
}

evictGraphicLibs() {
	pkill -f "vmtouch -Ld ${graphicLibs64[@]} ${graphicLibs32[@]}"
	echo 3 >/proc/sys/vm/drop_caches
}

preloadGameStuff() {
	echo 3 >/proc/sys/vm/drop_caches
	appDir=$(dirname $(pm path $1 | head -n 1 | cut -d: -f2))
	for cache in ${gameCache[@]}; do
		if [ -f /sdcard/Android/data/$1/$cache ] || [ -d /sdcard/Android/data/$1/$cache ]; then
			 itemsGameStuff+=("/sdcard/Android/data/$1/$cache")
		fi
	done
	[ -f $appDir/base.apk ] && itemsGameStuff+=("$appDir/base.apk")
	[ -f $appDir/split_config.arm64_v8a.apk ] && itemsGameStuff+=("$appDir/split_config.arm64_v8a.apk")
	[ -f $appDir/split_config.armeabi-v7a.apk ] && itemsGameStuff+=("$appDir/split_config.armeabi-v7a.apk")
	su -c vmtouch -Ld ${itemsGameStuff[@]}
	echo "${itemsGameStuff[@]}" >$last_gamepreloaded
}

evictGameStuff() {
	pkill -f "vmtouch -Ld $(cat $last_gamepreloaded)"
	echo 3 >/proc/sys/vm/drop_caches
}

case "$1 $2" in
"1 1") preloadGraphicLibs ;;
"1 0") evictGraphicLibs ;;
"2 1") [ ! -z "$3" ] && [ $(cat /data/encore/preload_game) -eq 1 ] && preloadGameStuff "$3" ;;
"2 0") [ $(cat /data/encore/preload_game) -eq 1 ] && evictGameStuff ;;
esac
