#!/system/bin/sh

apply() {
	if [ -f $2 ]; then
		chmod 644 $2 >/dev/null 2>&1
		echo $1 >$2
		chmod 444 $2 >/dev/null 2>&1
	fi
}

# CPU tweaks
cpu="0"
while [ $cpu -lt $(nproc --all) ]; do
	cpu_dir="/sys/devices/system/cpu/cpu${cpu}"
	if [ -d "$cpu_dir" ]; then
		apply 1 ${cpu_dir}/online
		chmod 0644 "${cpu_dir}/cpufreq/scaling_governor"
		chmod 000 "${cpu_dir}/cpufreq/cpuinfo_max_freq"
		chmod 000 "${cpu_dir}/cpu_capacity"
		chmod 000 "${cpu_dir}/topology/physical_package_id"
	fi
	cpu="$((cpu + 1))"
done

# Networking tweaks
apply "cubic" /proc/sys/net/ipv4/tcp_congestion_control
apply "1" /proc/sys/net/ipv4/tcp_low_latency
apply "1" /proc/sys/net/ipv4/tcp_ecn
apply "3" /proc/sys/net/ipv4/tcp_fastopen
apply "1" /proc/sys/net/ipv4/tcp_sack
apply "0" /proc/sys/net/ipv4/tcp_timestamps
apply "0" /proc/sys/net/ipv4/tcp_syncookies

# Disable ccci debugging
apply 0 /sys/kernel/ccci/debug

# Thermal governor
for thermal in /sys/class/thermal/thermal_zone*; do
	apply "step_wise" ${thermal}/policy
done

# Disable printk logging
apply "0 0 0 0" /proc/sys/kernel/printk
apply "off" /proc/sys/kernel/printk_devkmsg
apply "Y" /sys/module/printk/parameters/console_suspend
apply "N" /sys/module/printk/parameters/cpu
apply "0" /sys/kernel/printk_mode/printk_mode
apply "Y" /sys/module/printk/parameters/ignore_loglevel
apply "N" /sys/module/printk/parameters/pid
apply "N" /sys/module/printk/parameters/time

# Disable schedstats
apply 0 /proc/sys/kernel/sched_schedstats

# Stop tracing
stop traced
apply 0 /sys/kernel/tracing/tracing_on
