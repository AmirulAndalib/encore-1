#!/system/bin/sh

apply() {
	if [ -f $2 ]; then
		chmod 644 $2 >/dev/null 2>&1
		echo $1 >$2
		chmod 444 $2 >/dev/null 2>&1
	fi
}

# I/O Tweaks
for queue in /sys/block/*/queue; do
	# Do not use I/O as a source of randomness
	apply 0 "$queue/add_random"

	# Disable I/O statistics accounting
	apply 0 "$queue/iostats"
done

# CPU tweaks
cpu="0"
while [ $cpu -lt $(nproc --all) ]; do
	cpu_dir="/sys/devices/system/cpu/cpu${cpu}"
	if [ -d "$cpu_dir" ]; then
		apply 1 ${cpu_dir}/online
	fi
	cpu="$((cpu + 1))"
done

# Networking tweaks
apply "cubic" /proc/sys/net/ipv4/tcp_congestion_control
apply "1" /proc/sys/net/ipv4/tcp_low_latency
apply "1" /proc/sys/net/ipv4/tcp_ecn
apply "3" /proc/sys/net/ipv4/tcp_fastopen
apply "1" /proc/sys/net/ipv4/tcp_sack
apply "0" /proc/sys/net/ipv4/tcp_timestamps
apply "0" /proc/sys/net/ipv4/tcp_syncookies

# Disable ccci debugging
apply 0 /sys/kernel/ccci/debug

# Thermal governor
for thermal in /sys/class/thermal/thermal_zone*; do
	apply "step_wise" ${thermal}/policy
done

# Disable printk logging
apply "0 0 0 0" /proc/sys/kernel/printk
apply "off" /proc/sys/kernel/printk_devkmsg
apply "Y" /sys/module/printk/parameters/console_suspend
apply "N" /sys/module/printk/parameters/cpu
apply "0" /sys/kernel/printk_mode/printk_mode
apply "Y" /sys/module/printk/parameters/ignore_loglevel
apply "N" /sys/module/printk/parameters/pid
apply "N" /sys/module/printk/parameters/time

# Disable schedstats
apply 0 /proc/sys/kernel/sched_schedstats

# Stop tracing
stop traced
apply 0 /sys/kernel/tracing/tracing_on

# Disable read-ahead for swap devices
apply 0 /proc/sys/vm/page-cluster

# Update /proc/stat less often to reduce jitter
apply 120 /proc/sys/vm/stat_interval
